<%@ taglib uri="/struts-tags" prefix="s"%>
<%@ taglib uri="http://java.sun.com/jstl/core_rt" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib prefix="tiles" uri="http://tiles.apache.org/tags-tiles"%>

<tiles:insertDefinition name="baseLayout">
	<tiles:putAttribute name="title" value="Hello WebSocket" type="String" />
	<tiles:putAttribute name="java_script" type="String">
		<script src="sockjs-0.3.4.js"></script>
		<script src="stomp.js"></script>
		<script
			src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>

		<script type="text/javascript">
			/*
			var source = new EventSource("/TemplateWebApp/wst/sse-questions");

			source.addEventListener('spring', function(event) {
				$('#questions').prepend(event.data);
			});
			*/
			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");

			//function postQuestion() {

				//alert($('#newQuestionForm').serialize());

				//var dataVal = $('#newQuestionForm').serialize();

				//$.post('/TemplateWebApp/wst/sse-new-questions', dataVal);

				/*
				$.ajax({
					url : '/TemplateWebApp/wst/new-questions',
					type : 'post',
					data : dataVal,
					contentType : 'application/xml;charset=UTF-8',
					beforeSend : function(xhr) {
						xhr.setRequestHeader(header, token);
					}
				});*/
			//}
		</script>
		
		<script type="text/javascript">
			var ws = new WebSocket("ws://localhost:8080/TemplateWebApp/wst/ws-questions");
			
			ws.onopen = function(){
				ws.send("i am opened..");				
			}
			
			ws.onmessage = function(event){
				console.log("message="+event.data);
				$('#questions').prepend("<br>");
				$('#questions').prepend(event.data);
			}
			
			ws.onlcose = function(event){
				console.log("closed="+event.data);
			}
			
			function postQuestion() {
				ws.send($('#newQuestionText').val());
			}
		</script>

		<script type="text/javascript">
			var stompClient = null;

			function setConnected(connected) {
				document.getElementById('connect').disabled = connected;
				document.getElementById('disconnect').disabled = !connected;
				document.getElementById('conversationDiv').style.visibility = connected ? 'visible'
						: 'hidden';
				document.getElementById('response').innerHTML = '';
			}

			function connect() {
				var socket = new SockJS('/TemplateWebApp/wst/hello');
				stompClient = Stomp.over(socket);
				stompClient
						.connect(
								{},
								function(frame) {
									setConnected(true);
									console.log('Connected: ' + frame);
									stompClient
											.subscribe(
													'/topic/greetings',
													function(greeting) {
														showGreeting(JSON
																.parse(greeting.body).content);
													});
								});
			}

			function onLoadHandler() {
				//disconnect();
			}

			function disconnect() {
				if (stompClient != null) {
					stompClient.disconnect();
				}
				setConnected(false);
				console.log("Disconnected");
			}

			function sendName() {
				var name = document.getElementById('name').value;
				stompClient.send("/app/hello", {}, JSON.stringify({
					'name' : name
				}));
			}

			function showGreeting(message) {
				var response = document.getElementById('response');
				var p = document.createElement('p');
				p.style.wordWrap = 'break-word';
				p.appendChild(document.createTextNode(message));
				response.appendChild(p);
			}
		</script>
	</tiles:putAttribute>
	<tiles:putAttribute name="menu" value="" type="String" />
	<tiles:putAttribute name="body">
		<div>
			<form id="newQuestionForm" onsubmit="return false;">
				Question : <input type="text" id="newQuestionText"  />
				<button onclick="postQuestion();">Post Question</button>
				<div id="questions"></div>
			</form>
		</div>

		<div>
			<div>
				<button id="connect" onclick="connect();">Connect</button>
				<button id="disconnect" disabled="disabled" onclick="disconnect();">Disconnect</button>
			</div>
			<div id="conversationDiv">
				<label>What is your name?</label><input type="text" id="name" />
				<button id="sendName" onclick="sendName();">Send</button>
				<p id="response"></p>
			</div>
		</div>
	</tiles:putAttribute>
</tiles:insertDefinition>



</html>